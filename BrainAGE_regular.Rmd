---
title: "BrainAGE"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

This document is to create and populate the brainAGE template that is needed to calculate brainAGE using the https://centilebrain.org/#/brainAge2. 

## Load Libraries

```{r}
library(readxl)
library(openxlsx)
library(stringr)
library(dplyr)
library(readr)
```
Load necessary brainage template, demographic file, aseg and aparc files for brainAGE analysis. 

Change sex to "Male" or "Female" depending on analysis.

```{r}
#Load excel file
template_brainage <- read_excel("~/Data/raw/brainAGE_template.xlsx")

this_sex <- "Female"

#Load Aseg file (or equivalent)
aseg_data <- read_csv("~/Data/raw/combined_brainmeasures.csv")

#Load Aparc file
aparc_data <- read_csv("~/Data/raw/aparc_wide.csv")

#Load demographics file
demographics <- read_tsv("~/Data/raw/study-HBN_desc-participants.tsv")
```

Function to clean and standardize subject IDs for the aseg, surface area, and thickness data. 
```{r}
#save the original column names
original_template_column_names <- colnames(template_brainage)

clean_subject_ids_tsv <- function(df) {
  colnames(df)[1] <- "participant_id"  # Rename the first column
  df <- df %>%
    mutate(clean_subject_id = str_remove(participant_id, "^sub-"))  # Remove "sub-" from start
  return(df)
}

aseg_data_clean <- clean_subject_ids_tsv(aseg_data)
aparc_data_clean <- clean_subject_ids_tsv(aparc_data)

```

Rename subject_id to clean_subject_id in the demographic file (to standardize the column name)

```{r}
template_df <- template_brainage %>%
  rename(clean_subject_id = SubjectID)

demographics_df <- demographics %>%
  rename(clean_subject_id = participant_id)
```

```{r}
standardize_aseg_columns <- function(df) {
    col_names <- colnames(df)

  # Replace full names with abbreviations for hippocampus and thalamus
  col_names <- str_replace(col_names, "Left_Thalamus_Proper_Volume_mm3", "Lthal")
  col_names <- str_replace(col_names, "Left_Caudate_Volume_mm3", "Lcaud")
  col_names <- str_replace(col_names, "Left_Putamen_Volume_mm3", "Lput")
  col_names <- str_replace_all(col_names, "Left_Pallidum_Volume_mm3", "Lpal")
  col_names <- str_replace_all(col_names, "Left_Hippocampus_Volume_mm3", "Lhippo")
  col_names <- str_replace_all(col_names, "Left_Amygdala_Volume_mm3", "Lamyg")
  col_names <- str_replace_all(col_names, "Left_Accumbens_area_Volume_mm3", "Laccumb")
  
  col_names <- str_replace(col_names, "Right_Thalamus_Proper_Volume_mm3", "Rthal")
  col_names <- str_replace(col_names, "Right_Caudate_Volume_mm3", "Rcaud")
  col_names <- str_replace(col_names, "Right_Putamen_Volume_mm3", "Rput")
  col_names <- str_replace_all(col_names, "Right_Pallidum_Volume_mm3", "Rpal")
  col_names <- str_replace_all(col_names, "Right_Hippocampus_Volume_mm3", "Rhippo")
  col_names <- str_replace_all(col_names, "Right_Amygdala_Volume_mm3", "Ramyg")
  col_names <- str_replace_all(col_names, "Right_Accumbens_area_Volume_mm3", "Raccumb")
  
  colnames(df) <- col_names  
  return(df)
}

aseg_renamed <- standardize_aseg_columns(aseg_data_clean)

```

standardize column names for the thickness and surface area data. Need to change names of the some of the variables to match the template file. 

```{r}
standardize_col_names <- function(df) {
  col_names <- colnames(df)
  
  # Standardize prefixes and fix naming typos
  col_names <- str_replace_all(col_names, "lh", "L")
  col_names <- str_replace_all(col_names, "rh", "R")
  col_names <- str_replace_all(col_names, "entorhinal", "entorhil")
  col_names <- str_replace_all(col_names, "entoRinal", "entorhil")
  col_names <- str_replace_all(col_names, "supramarginal", "supramargil")
  col_names <- str_replace_all(col_names, "ThickAvg", "thickavg")
  col_names <- str_replace_all(col_names, "SurfArea", "surfavg")
  
  colnames(df) <- col_names
  return(df)
}

aparc_renamed <- standardize_col_names(aparc_data_clean)
```

First filters for time point because we only want baseline scans (also prevents duplicate subject_IDs in the final output). Then filters for sex and then creates a dataframe with subject Id, age, and sex. 

```{r}

gendered_data <- demographics_df %>%
  filter(sex == this_sex) %>%  # Then filter for sex
  select(clean_subject_id, age, sex)  # Keep subject ID, age, and sex for merging

```

Filter the aseg data for the sex

```{r}
gendered_aseg_data_clean <- aseg_renamed %>%
  filter(clean_subject_id %in% gendered_data$clean_subject_id)

gendered_aparc_data_clean <- aparc_renamed %>%
  filter(clean_subject_id %in% gendered_data$clean_subject_id)
```

Add the sex specific subject_ID, age, and assigned sex to the template_df and this also ensures that there are enough rows to merge the data. 

```{r}

# Make sure the subject_ids, sex, and age are character data types
template_df$clean_subject_id <- as.character(template_df$clean_subject_id)
template_df$sex <- as.character(template_df$sex)  # Add sex column conversion
template_df$age <- as.character(template_df$age)  # Add age column conversion

# First, check if template_df has rows
if (nrow(template_df) == 0) {
  # Create an empty data frame with the same structure as template_df but add the subject IDs and age
  # Keep all the original columns, but add the new data
  template_df <- template_df[0, ]  # Retain column structure but no rows
  
  # Now create a new data frame that only updates clean_subject_id and AGE
  new_data <- data.frame(clean_subject_id =gendered_data$clean_subject_id,
                         age = gendered_data$age,
                         sex = gendered_data$sex,
                         stringsAsFactors = FALSE)
  
  # Make them the same data type
  new_data$clean_subject_id <- as.character(new_data$clean_subject_id)
  new_data$sex <- as.character(new_data$sex)
  new_data$age <- as.character(new_data$age)
  
  # Bind the new data to the empty template, ensuring columns remain intact
  template_df <- bind_rows(template_df, new_data)
} else {
  
  # If template_df already has rows, just update clean_subject_id and AGE columns
  template_df$clean_subject_id <- gendered_data$clean_subject_id
  template_df$age <- gendered_data$age
}
```

Add the default values for the SITE (1 because they were all taken at the same site on the same scanner), ScannerType, and FreeSurfer_Version. Change values if needed. 

```{r}

# Create a named list of default values for columns with missing data
default_values <- list(
  SITE = "1",
  ScannerType = "3",
  FreeSurfer_Version = "7.0"
)

# Update existing columns with default values if they are NA
for (col in names(default_values)) {
  if (col %in% names(template_df)) {
    template_df[[col]] <- ifelse(is.na(template_df[[col]]), default_values[[col]], template_df[[col]])
  }
}
```

Convert all the columns from the files that need to be merged to characters so that they can be merged.

```{r}

# Convert all columns in the template_df to characters
template_df <- template_df %>%
  mutate(across(everything(), as.character))

gendered_aseg_data_clean <- gendered_aseg_data_clean %>%
  mutate(across(everything(), as.character))

gendered_aparc_data_clean <- gendered_aparc_data_clean %>%
  mutate(across(everything(), as.character))

```

Populate the template df by joining the aseg, surface area, and thickness data. 

```{r}
final_template <- left_join(template_df[, c(1, 2, 3, 4, 5, 6)], gendered_aseg_data_clean, by = "clean_subject_id") %>%  
  left_join(gendered_aparc_data_clean, by = "clean_subject_id") 

# Select only the columns from template_df
final_template <- final_template %>%
  select(names(template_df))  # Keeps only the columns in template_df  

#remove columns with NA
final_template <- final_template %>%
  filter(!is.na(final_template[[7]]))

#Revert back to original column names found in the template
colnames(final_template)[1:length(original_template_column_names)] <- original_template_column_names

```

Make sure all the data types are numeric because the calculator will not work if they are different data types. 

```{r}

# Convert all other rows and columns to numeric

numeric_data <- final_template %>%
  mutate(across(-c(SubjectID, sex), ~ as.numeric(.)))

```

Save the final populated template into a new Excel file

```{r}

output_file <- paste0("~/Data/processed/", tolower(sex), "_populated_brainAGE_template.xlsx")
write.xlsx(numeric_data, output_file)

print(paste("Template has been populated and saved as", output_file))
```